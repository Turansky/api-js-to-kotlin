import static com.yworks.yfiles.api.generator.Generator.generateKotlinWrappers

group 'com.yworks.yfiles'
version '0.1-SNAPSHOT'

buildscript {
    ext.kotlin_version = '1.2.10'
    repositories {
        mavenCentral()
    }
    dependencies {
        classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version"
    }
}

apply plugin: 'kotlin2js'

clean.doFirst {
    delete 'src/main/kotlin'

    delete 'web'
}

compileKotlin2Js {
    kotlinOptions {
        outputFile = "${projectDir}/web/index.js"
        moduleKind = 'amd'
        metaInfo = false
        sourceMap = false
    }
}

task generateSources() {
    // def source = project.properties["apiPath"] ?: throw GradleException("Invalid 'apiPath' parameter value!")
    def apiPath = "http://docs.yworks.com/yfileshtml/assets/api.04860ba1.js"
    generateKotlinWrappers(loadPath(apiPath), new File(projectDir, 'src/main/kotlin'))
}

compileKotlin2Js.dependsOn generateSources

sourceSets {
    main.kotlin.srcDirs += 'src/main/kotlin'
}

repositories {
    mavenCentral()
}

dependencies {
    compile "org.jetbrains.kotlin:kotlin-stdlib-js:$kotlin_version"
}

def loadPath(path) {
    def start = "var apiData="
    return new URL(path).getText("UTF-8").substring(start.length())
}