import static com.yworks.yfiles.api.generator.Generator.generateKotlinWrappers
import static com.yworks.yfiles.api.generator.Generator.generateJavaWrappers

group 'com.yworks.yfiles'
version '2.1.0.4-SNAPSHOT'

buildscript {
    ext.kotlin_version = '1.3.0-rc-146'
    repositories {
        mavenCentral()
        maven { url "http://dl.bintray.com/kotlin/kotlin-eap" }
    }
    dependencies {
        classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version"
    }
}

apply plugin: 'kotlin2js'
apply plugin: 'maven-publish'

clean.doLast {
    delete 'out'
}

compileKotlin2Js {
    kotlinOptions {
        outputFile = "${projectDir}/out/yfiles-kotlin.js"
        moduleKind = 'amd'
        metaInfo = true
    }
}

task generateSources() {
    def apiPath = "https://docs.yworks.com/yfileshtml/assets/api.8b4a0a73.js"
    generateKotlinWrappers(apiPath, new File(projectDir, 'src/main/kotlin'))
    generateJavaWrappers(apiPath, new File(projectDir, 'jsinterop/src/main/java'))
}

compileKotlin2Js.dependsOn generateSources

sourceSets {
    main.kotlin.srcDirs += 'src/main/kotlin'
}

repositories {
    mavenCentral()
    maven { url "http://dl.bintray.com/kotlin/kotlin-eap" }
}

dependencies {
    compile "org.jetbrains.kotlin:kotlin-stdlib-js:$kotlin_version"
}

task mainJar(type: Jar) {
    from "$projectDir/out"
}

task sourceJar(type: Jar) {
    from "$projectDir/src/main/kotlin"
}

publishing {
    publications {
        maven(MavenPublication) {
            artifact mainJar

            artifact sourceJar {
                classifier "sources"
            }
        }
    }
}

wrapper {
    distributionType = Wrapper.DistributionType.ALL
}